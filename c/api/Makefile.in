
srcdir=@srcdir@
VPATH=@srcdir@
top_srcdir=@api_srcdir@
top_blddir=@api_builddir@

#
# API (MyMMSC Portable Runtime) library Makefile.
#
CPP = @CPP@

# get substituted into some targets
API_MAJOR_VERSION=@API_MAJOR_VERSION@

#
# Macros for supporting directories
#
INCDIR=./include
OSDIR=$(top_srcdir)/include/arch/@OSDIR@
DEFOSDIR=$(INCDIR)/arch/@DEFAULT_OSDIR@
INCLUDES=-I$(INCDIR) -I$(OSDIR) -I$(DEFOSDIR) -I$(top_srcdir)/include/arch/@DEFAULT_OSDIR@ -I$(top_srcdir)/include -I$(top_srcdir)/include/private -I$(top_blddir)/include/private

#
# Macros for target determination
#
CLEAN_SUBDIRS= test
INSTALL_SUBDIRS=@INSTALL_SUBDIRS@

TARGET_LIB = lib@API_LIBNAME@.la
API_PCFILE = api-$(API_MAJOR_VERSION).pc
API_CONFIG = api-$(API_MAJOR_VERSION)-config
INSTALL = @INSTALL@
INSTALL_DATA = @INSTALL_DATA@

EXTRA_OBJECTS = @EXTRA_OBJECTS@
API_DSO_MODULES = @API_DSO_MODULES@
LINK_MODULE = $(LIBTOOL) $(LTFLAGS) --mode=link $(CC) $(LT_LDFLAGS) $(ALL_CFLAGS) $(ALL_LDFLAGS) $(APIUTIL_LDFLAGS) -release $(API_MAJOR_VERSION) -module -rpath $(API_DSO_LIBDIR)
API_DSO_LIBDIR = @API_DSO_LIBDIR@
APIUTIL_EXPORT_LIBS = @APIUTIL_EXPORT_LIBS@

#
# Rules for building specific targets, starting with 'all' for
# building the entire package.
#
TARGETS = $(TARGET_LIB) $(API_DSO_MODULES) \
	include/private/api_escape_test_char.h api.exp api-config.out build/api_rules.out

LT_VERSION = @LT_VERSION@

# bring in rules.mk for standard functionality
@INCLUDE_RULES@
@INCLUDE_OUTPUTS@

CLEAN_TARGETS = api-config.out api.exp exports.c export_vars.c .make.dirs \
	build/api_rules.out tools/gen_test_char@EXEEXT@ \
	tools/gen_test_char.o tools/gen_test_char.lo \
	include/private/api_escape_test_char.h
DISTCLEAN_TARGETS = config.cache config.log config.status \
	include/api.h include/arch/unix/api_private.h \
	libtool $(API_CONFIG) build/api_rules.mk api.pc \
	build/pkg/pkginfo
EXTRACLEAN_TARGETS = configure aclocal.m4 include/arch/unix/api_private.h.in \
	build-outputs.mk build/ltcf-c.sh build/aclocal.m4 \
	build/ltconfig build/ltmain.sh \
	build/argz.m4 build/libtool.m4 build/ltoptions.m4 \
	build/ltsugar.m4 build/ltversion.m4 build/lt~obsolete.m4

prefix=@prefix@
exec_prefix=@exec_prefix@
bindir=@bindir@
libdir=@libdir@
includedir=@includedir@
installbuilddir=@installbuilddir@

# Create api-config script suitable for the install tree
api-config.out: $(API_CONFIG)
	sed 's,^\(location=\).*$$,\1installed,' < $(API_CONFIG) > $@

# Create api_rules.mk suitable for the install tree
build/api_rules.out: build/api_rules.mk
	sed -e 's,^\(api_build.*=\).*$$,\1$(installbuilddir),' -e 's,^\(top_build.*=\).*$$,\1$(installbuilddir),' < build/api_rules.mk > $@

install: $(TARGETS)
	$(API_MKDIR) $(DESTDIR)$(libdir) $(DESTDIR)$(bindir) $(DESTDIR)$(installbuilddir) \
		     $(DESTDIR)$(libdir)/pkgconfig $(DESTDIR)$(includedir)
	$(INSTALL_DATA) $(top_blddir)/include/api.h $(DESTDIR)$(includedir)
	for f in $(top_srcdir)/include/api_*.h; do \
	    $(INSTALL_DATA) $${f} $(DESTDIR)$(includedir); \
	done
	$(LIBTOOL) --mode=install $(INSTALL) -m 755 $(TARGET_LIB) $(DESTDIR)$(libdir)
	$(INSTALL_DATA) api.exp $(DESTDIR)$(libdir)/api.exp
	$(INSTALL_DATA) api.pc $(DESTDIR)$(libdir)/pkgconfig/$(API_PCFILE)
	for f in libtool shlibtool; do \
	    if test -f $${f}; then $(INSTALL) -m 755 $${f} $(DESTDIR)$(installbuilddir); fi; \
	done
	$(INSTALL) -m 755 $(top_srcdir)/build/mkdir.sh $(DESTDIR)$(installbuilddir)
	for f in make_exports.awk make_var_export.awk; do \
	    $(INSTALL_DATA) $(top_srcdir)/build/$${f} $(DESTDIR)$(installbuilddir); \
	done
	$(INSTALL_DATA) build/api_rules.out $(DESTDIR)$(installbuilddir)/api_rules.mk
	$(INSTALL) -m 755 api-config.out $(DESTDIR)$(bindir)/$(API_CONFIG)
	@if [ $(INSTALL_SUBDIRS) != "none" ]; then \
            for i in $(INSTALL_SUBDIRS); do \
	        ( cd $$i ; $(MAKE) DESTDIR=$(DESTDIR) install ); \
	    done \
	fi

$(TARGET_LIB): $(OBJECTS) $(EXTRA_OBJECTS)
	$(LINK) @lib_target@ $(EXTRA_OBJECTS) $(ALL_LIBS) $(APIUTIL_EXPORT_LIBS)

encoding/api_escape.lo: include/private/api_escape_test_char.h 

exports.c: $(HEADERS)
	$(API_MKEXPORT) $(HEADERS) > $@

export_vars.c: $(HEADERS)
	$(API_MKVAREXPORT) $(HEADERS) > $@

api.exp: exports.c export_vars.c
	@echo "#! lib@API_LIBNAME@.so" > $@
	@echo "* This file was AUTOGENERATED at build time." >> $@
	@echo "* Please do not edit by hand." >> $@
	$(CPP) $(ALL_CPPFLAGS) $(ALL_INCLUDES) exports.c | grep "ap_hack_" | sed -e 's/^.*[)]\(.*\);$$/\1/' >> $@
	$(CPP) $(ALL_CPPFLAGS) $(ALL_INCLUDES) export_vars.c | sed -e 's/^\#[^!]*//' | sed -e '/^$$/d' >> $@

dox:
	doxygen $(top_srcdir)/docs/doxygen.conf

gcov: 
	@build/run-gcov.sh

test: check
check: $(TARGET_LIB)
	cd test && $(MAKE) all check

etags:
	etags `find . -name '*.[ch]'`

OBJECTS_gen_test_char = tools/gen_test_char.lo $(LOCAL_LIBS)
tools/gen_test_char.lo: tools/gen_test_char.c
	$(API_MKDIR) tools
	$(LT_COMPILE)

tools/gen_test_char@EXEEXT@: $(OBJECTS_gen_test_char)
	$(LINK_PROG) $(OBJECTS_gen_test_char) $(ALL_LIBS)

include/private/api_escape_test_char.h: tools/gen_test_char@EXEEXT@
	$(API_MKDIR) include/private
	tools/gen_test_char@EXEEXT@ > $@

LINK_PROG = $(LIBTOOL) $(LTFLAGS) --mode=link $(COMPILE) $(LT_LDFLAGS) \
	    @LT_NO_INSTALL@ $(ALL_LDFLAGS) -o $@

# DO NOT REMOVE
docs: $(INCDIR)/*.h
