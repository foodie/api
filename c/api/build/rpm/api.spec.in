
%define apiver 2

Summary: MyMMSC Portable Runtime library
Name: api
Version: API_VERSION
Release: API_RELEASE
License: MyMMSC Software License
Group: System Environment/Libraries
URL: http://api.mymmsc.org/
Source0: http://www.mymmsc.org/dist/api/%{name}-%{version}.tar.bz2
BuildRoot: %{_tmppath}/%{name}-%{version}-%{release}-buildroot
BuildRequires: autoconf, libtool, doxygen, python, libuuid

%description
The mission of the MyMMSC Portable Runtime (API) is to provide a
free library of C data structures and routines, forming a system
portability layer to as many operating systems as possible,
including Unices, MS Win32, BeOS and OS/2.

%package devel
Group: Development/Libraries
Summary: API library development kit
Requires: api = %{version}

%description devel
This package provides the support files which can be used to 
build applications using the API library.  The mission of the
MyMMSC Portable Runtime (API) is to provide a free library of 
C data structures and routines.

%package dbm
Group: Development/Libraries 
Summary: API utility library DBM driver
BuildRequires: db4-devel
Requires: api-util = %{version}-%{release}

%description dbm
This package provides the DBM driver for the api-util.

%package pgsql
Group: Development/Libraries
Summary: API utility library PostgreSQL DBD driver
BuildRequires: postgresql-devel
Requires: api-util = %{version}-%{release}

%description pgsql
This package provides the PostgreSQL driver for the api-util
DBD (database abstraction) interface.

%package mysql
Group: Development/Libraries
Summary: API utility library MySQL DBD driver
BuildRequires: mysql-devel
Requires: api-util = %{version}-%{release}

%description mysql
This package provides the MySQL driver for the api-util DBD
(database abstraction) interface.

%package sqlite
Group: Development/Libraries
Summary: API utility library SQLite DBD driver
BuildRequires: sqlite-devel >= 3.0.0
Requires: api-util = %{version}-%{release}

%description sqlite
This package provides the SQLite driver for the api-util DBD
(database abstraction) interface.

%package odbc
Group: Development/Libraries
Summary: API utility library ODBC DBD driver
BuildRequires: unixODBC-devel
Requires: api-util = %{version}-%{release}

%description odbc
This package provides the ODBC driver for the api-util DBD
(database abstraction) interface.

%package openssl
Group: Development/Libraries
Summary: API utility library OpenSSL crypto support
BuildRequires: openssl-devel
Requires: api-util = %{version}-%{release}

%description openssl
This package provides crypto support for api-util based on OpenSSL.

%package nss
Group: Development/Libraries
Summary: API utility library NSS crypto support
BuildRequires: nss-devel
Requires: api-util = %{version}-%{release}

%description nss
This package provides crypto support for api-util based on Mozilla NSS.

%prep
%setup -q

%build
# regenerate configure script etc.
./buildconf
%configure \
        --prefix=/usr \
        --includedir=%{_includedir}/api-%{apiver} \
        --with-installbuilddir=%{_libdir}/api/build-%{apiver} \
        --with-devrandom=/dev/urandom \
        --without-gdbm \
        --with-sqlite3 --with-pgsql --with-mysql --with-odbc \
        --with-berkeley-db \
        --with-crypto --with-openssl --with-nss \
        --without-sqlite2
        CC=gcc CXX=g++
make %{?_smp_mflags} && make dox

%check
# Run non-interactive tests
pushd test
make %{?_smp_mflags} all CFLAGS=-fno-strict-aliasing
make check || exit 1
popd

%install
rm -rf $RPM_BUILD_ROOT
make install DESTDIR=$RPM_BUILD_ROOT

# Move docs to more convenient location
mv docs/dox/html html

# Unpackaged files:
rm -f $RPM_BUILD_ROOT%{_libdir}/api.exp

%clean
rm -rf $RPM_BUILD_ROOT

%post -p /sbin/ldconfig

%postun -p /sbin/ldconfig

%files
%defattr(-,root,root,-)
%doc CHANGES LICENSE NOTICE
%{_libdir}/libapi-%{apiver}.so.*
%dir %{_libdir}/api-%{apiver}

%files dbm
%defattr(-,root,root,-)
%{_libdir}/api-%{apiver}/api_dbm_db*

%files pgsql
%defattr(-,root,root,-)
%{_libdir}/api-%{apiver}/api_dbd_pgsql*

%files mysql
%defattr(-,root,root,-)
%{_libdir}/api-%{apiver}/api_dbd_mysql*

%files sqlite
%defattr(-,root,root,-)
%{_libdir}/api-%{apiver}/api_dbd_sqlite*

%files odbc
%defattr(-,root,root,-)
%{_libdir}/api-%{apiver}/api_dbd_odbc*

%files openssl
%defattr(-,root,root,-)
%{_libdir}/api-%{apiver}/api_crypto_openssl*

%files nss
%defattr(-,root,root,-)
%{_libdir}/api-%{apiver}/api_crypto_nss*

%files devel
%defattr(-,root,root,-)
%doc docs/APIDesign.html docs/canonical_filenames.html
%doc docs/incomplete_types docs/non_api_programs
%doc --parents html
%{_bindir}/api*config
%{_libdir}/libapi-%{apiver}.*a
%{_libdir}/libapi-%{apiver}.so
%dir %{_libdir}/api
%dir %{_libdir}/api/build-%{apiver}
%{_libdir}/api/build-%{apiver}/*
%{_libdir}/pkgconfig/api-%{apiver}.pc
%dir %{_includedir}/api-%{apiver}
%{_includedir}/api-%{apiver}/*.h

%changelog
* Sat Aug 30 2008 Graham Leggett <minfrin@sharp.fm> 1.3.3
- update to depend on the bzip2 binary
- build depends on python

* Tue Jun 22 2004 Graham Leggett <minfrin@sharp.fm> 1.0.0-1
- update to support v1.0.0 of API

* Tue Jun 22 2004 Graham Leggett <minfrin@sharp.fm> 1.0.0-1
- derived from Fedora Core api.spec

